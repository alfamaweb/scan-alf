<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan - Teste de Analise</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f1e8;
      --bg-2: #f0e7d6;
      --ink: #1f1d18;
      --muted: #6b655c;
      --accent: #ff7a00;
      --accent-2: #3f7c79;
      --card: #ffffff;
      --stroke: #e7dfd2;
      --shadow: 0 18px 40px rgba(20, 18, 16, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top left, #ffe6c7 0, transparent 55%),
        radial-gradient(circle at 70% 10%, #d9f1f0 0, transparent 45%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: linear-gradient(135deg, rgba(0,0,0,0.04) 1px, transparent 1px);
      background-size: 34px 34px;
      pointer-events: none;
      opacity: 0.25;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 20px 64px;
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      align-items: center;
      margin-bottom: 32px;
    }

    .brand {
      display: grid;
      gap: 8px;
    }

    .brand h1 {
      margin: 0;
      font-family: "Fraunces", "Times New Roman", serif;
      font-size: clamp(2rem, 2.5vw, 2.8rem);
      letter-spacing: 0.5px;
    }

    .brand p {
      margin: 0;
      color: var(--muted);
      max-width: 520px;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .grid {
      display: grid;
      gap: 18px;
    }

    .grid.cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    label {
      display: grid;
      gap: 8px;
      font-weight: 600;
      color: var(--muted);
    }

    input[type="url"],
    input[type="number"] {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      font-size: 1rem;
      font-family: inherit;
      outline: none;
    }

    input:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 2px rgba(63, 124, 121, 0.2);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button, .btn {
      border: none;
      border-radius: 999px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: white;
      font-size: 1rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.secondary, .btn.secondary {
      background: var(--accent-2);
    }

    button:disabled, .btn[aria-disabled="true"] {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    button:not(:disabled):hover, .btn:not([aria-disabled="true"]):hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(255, 122, 0, 0.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #f6f1e7;
      color: var(--muted);
      border: 1px solid var(--stroke);
      font-size: 0.9rem;
    }

    .scores {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .score-card {
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 14px;
      background: #fff7ec;
    }

    .score-card strong {
      font-size: 1.6rem;
      display: block;
    }

    .score-help {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px dashed var(--stroke);
      background: #fffdf8;
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .score-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 0;
    }

    .legend-pill {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--stroke);
      background: #f6f1e7;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .report-grid {
      display: grid;
      gap: 16px;
    }

    .report-card {
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 16px;
      background: #fffdf6;
    }

    .report-card h4 {
      margin: 0 0 10px;
      font-size: 1.05rem;
      color: var(--ink);
    }

    .report-sub {
      margin-top: 10px;
      font-weight: 600;
      color: var(--ink);
    }

    .report-list {
      margin: 6px 0 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      color: var(--muted);
    }

    .report-list li {
      margin: 0;
    }

    .report-text {
      margin: 6px 0;
      color: var(--muted);
    }

    .report-kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 12px;
      margin-top: 6px;
      font-size: 0.95rem;
    }

    .report-kv span {
      color: var(--muted);
    }

    .report-kv strong {
      color: var(--ink);
      font-weight: 600;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.open {
      display: flex;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(22, 21, 18, 0.55);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      position: relative;
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--stroke);
      width: min(900px, 92vw);
      max-height: 85vh;
      overflow: hidden;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-rows: auto 1fr;
      z-index: 1;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      border-bottom: 1px solid var(--stroke);
      background: #fffaf2;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.4rem;
      cursor: pointer;
      color: var(--muted);
    }

    .modal-body {
      padding: 18px 20px;
      overflow-y: auto;
      display: grid;
      gap: 10px;
    }

    body.modal-open {
      overflow: hidden;
    }
    .findings {
      display: grid;
      gap: 12px;
    }

    .finding {
      border-left: 4px solid var(--accent-2);
      background: #f7fbfb;
      padding: 12px 14px;
      border-radius: 10px;
    }

    .finding.high { border-left-color: #d9534f; background: #fff2f1; }
    .finding.med { border-left-color: #f0ad4e; background: #fff8ec; }
    .finding.low { border-left-color: #5cb85c; background: #f1fff4; }

    .status {
      font-weight: 600;
      color: var(--muted);
    }

    .status strong { color: var(--ink); }

    .pages {
      display: grid;
      gap: 8px;
      max-height: 220px;
      overflow: auto;
      padding-right: 4px;
    }

    .page-item {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #faf7f1;
      font-size: 0.95rem;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .fade-up {
      animation: fadeUp 0.6s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .grid.cols-2 { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="panel grid fade-up">
      <div class="grid cols-2">
        <label>
          Analise j√° o seu site
          <input id="url" type="url" placeholder="https://site.com" />
        </label>
      </div>
      <div class="actions">
        <button id="analyzeBtn">Analisar agora</button>
        <button id="openReportBtn" class="btn secondary" aria-disabled="true">Abrir relatorio</button>
        <a id="downloadBtn" class="btn secondary" aria-disabled="true">Baixar PDF</a>
      </div>    </section>
    <div id="reportModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" data-close="true"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Relatorio completo</h3>
          <button id="closeReportBtn" class="modal-close" aria-label="Fechar">x</button>
        </div>
        <div class="modal-body">
          <div class="panel">
            <h4>Scores</h4>
            <div class="scores" id="scores"></div>
            <div class="score-help">
              <strong>Como calculamos:</strong> cada score comeca em 100 e perde pontos conforme os achados.
              <div class="score-legend">
                <span class="legend-pill">HIGH = -20</span>
                <span class="legend-pill">MED = -10</span>
                <span class="legend-pill">LOW = -4</span>
              </div>
              <div class="score-legend">
                <span class="legend-pill">SEO</span>
                <span class="legend-pill">A11Y</span>
                <span class="legend-pill">CONTENT</span>
                <span class="legend-pill">Overall = somatorio</span>
              </div>
            </div>
          </div>

          <div class="panel">
            <h4>Relatorio</h4>
            <div class="report-grid" id="reportBody"></div>
          </div>

          <div class="panel">
            <h4>Findings</h4>
            <div class="findings" id="findings"></div>
          </div>

          <div class="panel">
            <h4>Paginas analisadas</h4>
            <div class="pages" id="pages"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8000";
    const elUrl = document.getElementById("url");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const openReportBtn = document.getElementById("openReportBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusBox = document.getElementById("status");
    const scoresBox = document.getElementById("scores");
    const findingsBox = document.getElementById("findings");
    const reportBody = document.getElementById("reportBody");
    const pagesBox = document.getElementById("pages");
    const apiStatus = document.getElementById("apiStatus");
    const reportModal = document.getElementById("reportModal");
    const closeReportBtn = document.getElementById("closeReportBtn");

    let lastReportPath = null;

    async function checkApi() {
      try {
        const resp = await fetch(`${API_BASE}/health`);
        if (apiStatus) {
          apiStatus.textContent = resp.ok ? "online" : "offline";
        }
      } catch (err) {
        if (apiStatus) {
          apiStatus.textContent = "offline";
        }
      }
    }

    function setStatus(text) {
      if (!statusBox) return;
      statusBox.innerHTML = `Status: <strong>${text}</strong>`;
    }

    function renderScores(scores = {}) {
      const entries = [
        ["Overall", scores.overall],
        ["SEO", scores.SEO],
        ["A11Y", scores.A11Y],
        ["CONTENT", scores.CONTENT],
      ];

      if (!scoresBox) return;
      scoresBox.innerHTML = "";
      entries.forEach(([label, value]) => {
        const card = document.createElement("div");
        card.className = "score-card";
        card.innerHTML = `<span>${label}</span><strong>${value ?? "-"}</strong>`;
        scoresBox.appendChild(card);
      });
    }

    function renderFindings(findings = []) {
      if (!findingsBox) return;
      findingsBox.innerHTML = "";
      if (!findings.length) {
        findingsBox.innerHTML = "<div class='finding low'>Nenhum problema encontrado.</div>";
        return;
      }

      findings.forEach((f) => {
        const div = document.createElement("div");
        const sev = (f.severity || "LOW").toLowerCase();
        div.className = `finding ${sev}`;
        div.innerHTML = `<strong>[${f.severity}]</strong> ${f.id}<br/><span>${f.message}</span>`;
        findingsBox.appendChild(div);
      });
    }

    function isSectionHeader(line) {
      return line === line.toUpperCase() && line.length > 3;
    }

    function buildSections(lines) {
      const sections = [];
      let current = null;
      lines.forEach((line) => {
        if (isSectionHeader(line)) {
          current = { title: line, lines: [] };
          sections.push(current);
          return;
        }
        if (!current) {
          current = { title: "Relatorio", lines: [] };
          sections.push(current);
        }
        current.lines.push(line);
      });
      return sections;
    }

    function renderSummary(summary) {
      if (!reportBody) return;
      const text = (summary || "").trim();
      reportBody.innerHTML = "";
      if (!text) {
        reportBody.textContent = "Sem relatorio.";
        return;
      }
      const lines = text.split("\n").map((line) => line.trim()).filter(Boolean);
      const sections = buildSections(lines);
      sections.forEach((section) => {
        const card = document.createElement("div");
        card.className = "report-card";

        const title = document.createElement("h4");
        title.textContent = section.title;
        card.appendChild(title);

        let list = null;
        section.lines.forEach((line) => {
          if (line.endsWith(":") && !line.startsWith("- ") && !line.match(/^\d+\)/)) {
            const sub = document.createElement("div");
            sub.className = "report-sub";
            sub.textContent = line.replace(/:$/, "");
            card.appendChild(sub);
            list = document.createElement("ul");
            list.className = "report-list";
            card.appendChild(list);
            return;
          }

          const isBullet = line.startsWith("- ") || line.startsWith("\u2192") || line.match(/^\d+\)/);
          if (isBullet) {
            if (!list) {
              list = document.createElement("ul");
              list.className = "report-list";
              card.appendChild(list);
            }
            const li = document.createElement("li");
            li.textContent = line.replace("- ", "\u2022 ");
            list.appendChild(li);
            return;
          }

          if (line.includes(":")) {
            const parts = line.split(":");
            const key = parts.shift().trim();
            const value = parts.join(":").trim();
            const kv = document.createElement("div");
            kv.className = "report-kv";
            const keyEl = document.createElement("span");
            keyEl.textContent = key;
            const valEl = document.createElement("strong");
            valEl.textContent = value || "-";
            kv.appendChild(keyEl);
            kv.appendChild(valEl);
            card.appendChild(kv);
            list = null;
            return;
          }

          const p = document.createElement("p");
          p.className = "report-text";
          p.textContent = line;
          card.appendChild(p);
          list = null;
        });

        reportBody.appendChild(card);
      });
    }

    function openReport() {
      if (!reportModal) return;
      reportModal.classList.add("open");
      reportModal.setAttribute("aria-hidden", "false");
      document.body.classList.add("modal-open");
    }

    function closeReport() {
      if (!reportModal) return;
      reportModal.classList.remove("open");
      reportModal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    }

    function setOpenReportEnabled(enabled) {
      if (!openReportBtn) return;
      openReportBtn.setAttribute("aria-disabled", enabled ? "false" : "true");
      openReportBtn.disabled = !enabled;
    }

    function renderPages(pages = []) {
      if (!pagesBox) return;
      pagesBox.innerHTML = "";
      if (!pages.length) {
        pagesBox.textContent = "Nenhuma pagina listada.";
        return;
      }

      pages.forEach((p) => {
        const div = document.createElement("div");
        div.className = "page-item";
        div.innerHTML = `<strong>${p.status ?? "-"}</strong> - ${p.url}`;
        pagesBox.appendChild(div);
      });
    }

    function setDownload(path) {
      if (!downloadBtn) return;
      if (!path) {
        downloadBtn.setAttribute("aria-disabled", "true");
        downloadBtn.removeAttribute("href");
        return;
      }
      downloadBtn.setAttribute("aria-disabled", "false");
      downloadBtn.href = `${API_BASE}${path}`;
      downloadBtn.setAttribute("target", "_blank");
      downloadBtn.setAttribute("rel", "noreferrer");
    }

    analyzeBtn.addEventListener("click", async () => {
      const url = elUrl.value.trim();
      if (!url) return;

      document.body.classList.add("loading");
      setStatus("rodando analise...");
      setDownload(null);

      try {
        const resp = await fetch(`${API_BASE}/analyze`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url,
            mode: "site",
            max_pages: 500,
            max_depth: 5,
            consultancy: "AlfamaWeb",
          }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }

        const data = await resp.json();
        lastReportPath = data.report_path;

        renderScores(data.scores);
        renderSummary(data.report || data.summary);
        renderFindings(data.findings);
        renderPages(data.pages || []);
        setDownload(lastReportPath);
        setOpenReportEnabled(true);
        setStatus("analise concluida");
        openReport();
      } catch (err) {
        setStatus(`erro: ${err.message || err}`);
      } finally {
        document.body.classList.remove("loading");
      }
    });

    checkApi();

    setOpenReportEnabled(false);

    if (openReportBtn) {
      openReportBtn.addEventListener("click", () => openReport());
    }

    if (closeReportBtn) {
      closeReportBtn.addEventListener("click", () => closeReport());
    }
    if (reportModal) {
      reportModal.addEventListener("click", (event) => {
        if (event.target && event.target.dataset && event.target.dataset.close) {
          closeReport();
        }
      });
    }
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeReport();
      }
    });
  </script>
</body>
</html>
